"In computer science, a heartbeat is a periodic signal generated by hardware or software to indicate normal operation or to synchronize other parts of a computer system." - [Wikipedia](https://en.wikipedia.org/wiki/Heartbeat_(computing))

# Heartbeating

- [Overview](https://github.com/greiginsydney/Intervalometerator/blob/master/docs/setup-heartbeating.md#setup-heartbeating)
- [Setup Heartbeating](https://github.com/greiginsydney/Intervalometerator/blob/master/docs/setup-heartbeating.md#setup-heartbeating)
- [Setup "Dead Man’s Snitch"](https://github.com/greiginsydney/Intervalometerator/blob/master/docs/setup-heartbeating.md#setup-dead-mans-snitch)
- [Add "PagerDuty"](https://github.com/greiginsydney/Intervalometerator/blob/master/docs/setup-heartbeating.md#add-pagerduty)
- [Integrate Dead Man's Snitch with PagerDuty](https://github.com/greiginsydney/Intervalometerator/blob/master/docs/setup-heartbeating.md#integrate-dead-mans-snitch-with-pagerduty)

<hr />

## Overview

The intvlm8r can be set to send a periodic "check in" message - a heartbeat - to a remote web address. The remote service then generates an alert when a regularly-scheduled poll/heartbeat has been missed.

Any web address can be used for this: the onus is on the receiving service to identify the intvlm8r (typically through the use of a dedicated URL), log the heartbeats and determine when a heartbeat has been missed.

When enabled, the intvlm8r will send a heartbeat when the Pi is started or rebooted, and then a regular shedule, with options of 5, 10, 15, 20, 30 or 60 minutes. The user can also manually trigger a heartbeat from the /monitoring page, which is typically only used when setting up or debugging this feature.

The regular heartbeating process exercises multiple components of the intvlm8r as a way of ensuring that the failure of a critical component will result in the failure of the hearteat. A timer service triggers the execution of `heartbeat.py` every five minutes. This script runs, querying `intvlm8r.ini` to determine if it's time to initiate a heartbeat (and that a valid URL has been set). If a heartbeat is due, it generates an internal web call to the /heartbeat page. In responding to this request, the intvlm8r then passes the request to Celery to make the web call to the heartbeat url. Should any of these components be in a failed state, the heartbeat will not be sent and the monitoring service will trigger an alarm.

After each heartbeat is generated, the received web result is checked. If a "success" [status code](https://en.wikipedia.org/wiki/List_of_HTTP_status_codes) wasn't received the intvlm8r will attempt a second heartbeat. 

As heartbeat.py executes every five minutes, `intvlm8r.logrotate` constrains the space consumed by `heartbeat.log` to prevent log bloat. The intvlm8r logs the success/failure of heartbeat attempts to `gunicorn.error`, and the last result is stored in `hbresults.txt`, which is then shown on the /monitoring page.

The heartbeating service shown in this example is "Dead Man's Snitch", however any equivalent service can be used. "Dead Man's Snitch" offers a free tier, as well as multiple paid options. (We have no commercial relationship with "Dead Man's Snitch" or "PagerDuty", introduced later on this page.)
<br/>

[Top](https://github.com/greiginsydney/Intervalometerator/blob/master/docs/setup-heartbeating.md#setup-heartbeating)
<hr/>

## Setup Heartbeating

1. Heartbeating is enabled from the new `Remote monitoring` option on the hamburger menu:

<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/125580526-8d235030-c38f-4517-9d25-a0037d760b89.png" width="40%">
</p>

2. The `Apply` and `Heartbeat now` buttons are interlocked. If you make a change on this page the Apply button will be enabled, prompting you to save the change. Only once a change has been saved will the `Heartbeat now` button be enabled.

<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/125580029-c95dea9d-07b1-4d8c-a50f-dd199ffdf504.png" width="50%">
</p>

3. The heartbeat URL is checked for validity as you type. Invalid URLs will be shown with a red border around the field, and the buttons will be disabled:
<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/125581105-274363a2-889d-4a26-8dc0-16ef9d8657e2.png" width="50%">
</p>

4. Heartbeating will automatically commence the next time the minute is divisible by the selected frequency value, and always at the top of the hour.
<br>

[Top](https://github.com/greiginsydney/Intervalometerator/blob/master/docs/setup-heartbeating.md#setup-heartbeating)
<hr/>

## Setup "Dead Man’s Snitch"

11. Browse to [https://deadmanssnitch.com/](https://deadmanssnitch.com/)
12. Click the "SIGN UP" button in the top right corner & create yourself an account. Once you've done that you'll be automatically taken through the steps to setup your "plan" and create your first Snitch.
13. On the page "Choose a plan for your new Case", scroll to the bottom and click the button to select the "NO FRILLS FREE PLAN", or lash out with one of the paid options.
14. On the page "New Snitch", give it a name and select the Interval. (Note in this example of the free plan, some of the advanced options are greyed out):

<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/125729615-697d65d8-965d-431f-b759-8bae4222d8a0.png" width="80%">
</p>

15. Click SAVE.

16. You're done! It's that simple!!

<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/125729700-48c43ae9-32c9-4f49-86b8-dae9047ed364.png" width="80%">
</p>

17. Copy "Your Unique Snitch URL" and paste it into the URL field on the intvlm8r. Don't worry about losing it, you can always return to Dead Man's Snitch and retrieve it.

18. Before you get distracted, don't forget to respond to the confirmation e-mail in your inbox:

<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/125730218-fad365d5-e5b3-40dc-975a-e97f3bb7a6d8.png" width="80%">
</p>
<br>
[Top](https://github.com/greiginsydney/Intervalometerator/blob/master/docs/setup-heartbeating.md#setup-heartbeating)
<hr/>

## Add PagerDuty

Dead Man's Snitch will send you an e-mail if the intvlm8r fails to report in, however if you're not always in front of an e-mail client you might want something more immediate, like an SMS. If you have multiple intvlm8rs and several people on staff, you might be looking for some rostering and escalation, and here's where the power of PagerDuty can come in.

Pre-req's:
- you need a [Dead Man's Snitch plan](https://deadmanssnitch.com/plans) that supports "Integrations" for this.
- the [Professional plan](https://www.pagerduty.com/pricing/) at Pager Duty is the first to offer SMS notifications.

<br>

21. Browse to [https://www.pagerduty.com/](https://www.pagerduty.com/)
22. Click the "GET STARTED" button in the top right corner to create yourself an account.
23. Enter your e-mail address and click GET STARTED!
<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/126600261-dba8eea1-2a9e-4bf3-abd4-9a395452bf2f.png" width="40%">
</p>

24. Your subdomain here will become "subdomain.pagerduty.com", so I suggest you use your company name for that. Critical here is the US/EU question. I think it should be renamed, as it seems to be a question focussed on the GDPR requirements of customers in EU countries. If that's not you, PagerDuty recommend you go with the "US" option:
<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/126600550-923d64f0-f7f7-4976-926d-31d45fa2a5f8.png" width="40%">
</p>

25. As the text outlines here, each "service" in PagerDuty will be an intvlm8r:
<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/126600722-4caa4528-7377-499c-8343-50d9f685945c.png" width="60%">
</p>

26. Now, add the Dead Man's Snitch integration. You'll find that by searching on the "All" tab:
<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/126601155-0b7ba93a-222a-4cc5-b299-b9e6d24c91d1.png" width="60%">
</p><p align="center">[NB: I've edited this screen-grab to remove some white-space]</p>

27. By default the "How do you want to be notified" box will only let you enter a +1 country code for phone and SMS notifications, but fear not, for the rest of the world we're just a support ticket away from having access. If you're outside the US/CA/etc, click the "submit a ticket" link. That will launch a fresh browser tab: follow your nose there and return to this tab, click "Skip step" and continue.

<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/126602212-48cf0ebf-5d38-46e6-8531-0eeab3bcd5a2.png" width="60%">
</p>

28. You're done - that's the basics covered. There's lots of really helpful information on how to REALLY make PagerDuty work for you, starting with the "Onboarding Guide".
<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/126602569-c1e1da8d-f278-4966-92f6-234f462af3ae.png" width="60%">
</p>

29. Resources:
- [Getting Started checklist](https://pagerduty.influitive.com/forum/t/the-onboarding-checklist/1522)
- [http://www.pagerduty.com/docs/guides/dead-mans-snitch-integration-guide/](http://www.pagerduty.com/docs/guides/dead-mans-snitch-integration-guide/) - see the next section for a walk-through
- [https://community.pagerduty.com](https://community.pagerduty.com)

30. If you had to create a support ticket for SMS access, check back in a day or so, as they _don't_ send an e-mail when they've enabled you. Browse to People / Users / select your name and then "+ Add SMS Number" on the "Contact Information" tab. That's it.

<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/127473246-c09e5c8d-837a-46d7-bc81-0746cb7141d3.png" width="80%">
</p>
<br>

[Top](https://github.com/greiginsydney/Intervalometerator/blob/master/docs/setup-heartbeating.md#setup-heartbeating)
<hr/>

## Integrate Dead Man's Snitch with PagerDuty

You need to be on [the 'Medium' plan](https://deadmanssnitch.com/plans) or higher at Dead Man's Snitch for this.

41. Login to [https://deadmanssnitch.com/](https://deadmanssnitch.com/).
42. Select the Integrations tab:

<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/127466604-657dd286-6a5e-4f1c-acb4-649fe33233df.png" width="80%">
</p>

43. Click the "+ ADD" button next to Pager Duty. This will open a fresh page to a PagerDuty URL and prompt you to sign in with your PD credentials:

<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/127467043-77b0383e-21cd-4f34-b3dd-e1929651315e.png" width="40%">
</p>

44. Select your Pager Duty service and click the Connect button:
<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/127467349-08cc3ffc-97bf-40ec-9746-708a0273d68d.png" width="40%">
</p>

45. That's it! It couldn't be much easier. You'll then be returned to the Dead Man's Snitch page confirming your new integration is active:

<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/127467512-525f45b3-880c-4327-aa6e-11ca11bdf6e7.png" width="80%">
</p>

46. You don't need to make any more in-depth changes because you only have one Snitch and one Service at Pager Duty, so they're linked by default. Obviously if you have an existing or more comprehensive setup of either, you might need to make some tweaks, but that's beyond the scope of this intro article.

47. With the above setup, here's an SMS that Pager Duty sent me, alerting me that my intvlm8r had failed to report in:

<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/127468428-07a6ab82-25f4-4b55-b77d-b1e06b27c310.png" width="40%">
</p>

48. Despite what I said in Step 46, I found in my testing I wanted ONE extra bit of functionality: Pager Duty was letting me know when the intvlm8r was FAILING to report in, but was deathly silent when it came good, and that was some comforting news I was wanting to see on my phone. Never fear - Qisthy and the team at Pager Duty support had the answer for me.

49. From your Pager Duty desktop, select People, your user name, the Notification Rules tab, and under "When a high-urgency incident assigned to me changes...", click the "+ Add Notification Rule" button and add as many notifications as you wish. I'm already receiving an e-mail from Dead Man's Snitch when the intvlm8r starts reporting in again, so I only added an SMS here:

<p align="center">
<img src="https://user-images.githubusercontent.com/11004787/127469779-7f4a0b89-e5b1-4558-9560-dcd9c1e4d0b0.png" width="80%">
</p>
<br>

[Top](https://github.com/greiginsydney/Intervalometerator/blob/master/docs/setup-heartbeating.md#setup-heartbeating)
<hr/>
